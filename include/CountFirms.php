<?phperror_reporting(0);class DayItem {		private $db;	private $host;	private $password;	private $username;		public function SetMySQL($db, $host, $password, $username) {		$this->db = $db;		$this->host = $host;		$this->password = $password;		$this->username = $username;	}	public function CountAllFirms($city) {		$link = mysql_connect($this->host, $this->username, $this->password);		mysql_select_db($this->db);		mysql_query("set names utf8");				$cache = new RedisCache();		$hKey = "AllSites:RootGroups";		$rootGroups = $cache -> hGetAll($hKey);		//$rootGroups = array_flip($rootGroups);					$result = mysql_query("SELECT * FROM tt_address_group");		while($row = mysql_fetch_array($result))		{			$allGroups[$row['uid']] = $row['parent_group']; // СВОЙ НОМЕР = РОДИТЕЛЬСКАЯ ГРУППА		}				$result = mysql_query("SELECT * FROM tt_address_group_mm");		mysql_close($link);		while($row = mysql_fetch_array($result))		{			$relations[$row['uid_local']] = $row['uid_foreign']; // КОМПАНИЯ = ГРУППА		}				$fullNum = count($relations);		$countGroups = count($allGroups);		$x=0;		$resulted = array();		foreach ( $rootGroups as $rootKey => $rootValue ) {						$catName = $rootKey;					foreach ( $allGroups as $keyGroup => $valueGroup ) {				if ( $rootGroups[$catName] == $valueGroup ) {					$resulted[$catName][] .= $keyGroup;					$resulted[$catName][] .= $rootValue;					unset($allGroups[$keyGroup]);				}							}					}						foreach ( $resulted as $rootKey => $rootValue ) {// главная категория - массив			foreach ( $rootValue as $key => $value ) {// отбалдинский номер - номер подкатегории								foreach ( $allGroups as $allKey => $allValue ) {//свой номер - родительская группа										if ( $value == $allValue  ) {						$resulted[$rootKey][] .= $allKey;						unset($allGroups[$allValue]);					}									}							}		}				// теперь присчитываем компании в категории				foreach ( $resulted as $keyR => $valueR ) {				$katName = $keyR;					foreach ( $valueR as $key => $value ) {// корневая категория - входящие подкатегории								foreach ( $relations as $coNum => $coGroup ) {// номер компании - категория										if ( $value == $coGroup ) {												if ( $ended[$katName] == null ) {							$ended[$katName] = 1;						} else {							$ended[$katName] = $ended[$katName] + 1;						}											}									}							}		}					unset($ended['Торговые центры']);					#foreach ( $ended as $key => $value ) {		#	$ended[$key] = $value * 4;		#}				foreach ( $ended as $key => $value ) {			$cache -> hSetTimeout($city.":CountedFirms", $key, $value, 3600);		}				return $ended;			}	}